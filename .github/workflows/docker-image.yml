name: Docker Image CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:

  build:

    runs-on: ubuntu-latest
    services:
        postgres:
              image: postgres:14
              env:
                    POSTGRES_PASSWORD: postgres
              options: >-
                    --health-cmd pg_isready
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5
              ports:
                    - 5432:5432

    steps:
    - uses: actions/checkout@v2
    - name: Build the Docker image
      run: docker build . --file .build/Dockerfile --tag fastapi-piccolo:dev
    - name: Setup postgres
      run: |
            export PGPASSWORD=postgres
            psql -h localhost -c 'CREATE DATABASE test;' -U postgres
            
    - name: Setup env
      run: |
             touch .env
             echo DB_HOST=postgres >> .env
             echo DB_TEST_NAME=test >> .env
             echo DB_TEST_USER=postgres >> .env
             echo DB_TEST_PASSWORD=postgres >> .env
             echo DB_TEST_HOST=postgres >> .env
             echo DB_TEST_PORT=5432 >> .env
             cat .env
             
    - name: Run tests
      run: docker run fastapi-piccolo:dev piccolo tester run
    
    - name: Upload coverage
      uses: codecov/codecov-action@v1

             
